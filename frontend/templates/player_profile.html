<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ target.name }}'s Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  {% include '_navbar.html' %}
  <div class="container mt-4">
    <h2 class="mb-3 text-center">{{ target.name }}'s Last Game</h2>

    {% if recent_log %}
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <p><strong>Position:</strong> {{ target.position }}</p>
        <p><strong>Match Rating:</strong> {{ recent_log.rating }}</p>
        <p>⚽ Goals: {{ recent_log.goals }} | 🎯 Assists: {{ recent_log.assists }}</p>
        <p>🛡️ Tackles: {{ recent_log.tackles }} | 🧤 Saves: {{ recent_log.saves }}</p>
        <small class="text-muted">Match ID: {{ recent_log.match_id }}</small>
      </div>
    </div>

    {% if not is_admin %}
  {% set match_id = recent_log.match_id %}
  {% set already_players_player_rated = target.players_player_ratings | selectattr('from', 'equalto', viewer_id) | selectattr('match_id', 'equalto', match_id) | list | length > 0 %}

  {% if not already_players_player_rated %}
    <!-- Players' Player Rating Form -->
    <hr>
    <h5>👥 Players' Player Rating</h5>
    <form method="POST" action="{{ url_for('player_bp.players_player_rating', player_id=session['player_id']) }}">
      <input type="hidden" name="target_id" value="{{ target.id }}">
      <input type="hidden" name="match_id" value="{{ match_id }}">
      <div class="mb-3">
        <label for="players_player_rating">Players' Player Rating (1-5):</label>
        <input type="number" name="rating" id="players_player_rating" class="form-control" min="1" max="5" required>
      </div>
      <div class="mb-3">
        <label for="comment">💬 Comment (optional)</label>
        <textarea name="comment" id="comment" class="form-control" rows="2"></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Submit Players' Player Rating</button>
    </form>
  {% else %}
    <div class="alert alert-info">You’ve already rated {{ target.name }} for this match.</div>
  {% endif %}
{% endif %}

    {% else %}
      <div class="alert alert-warning">⚠️ No match data available for {{ target.name }} yet.</div>
    {% endif %}

    <div class="mt-4">
      {% if is_admin and from_admin %}
        <a href="{{ url_for('home_bp.index') }}" class="btn btn-secondary">Back to Dashboard</a>
      {% else %}
        <a href="{{ url_for('home_bp.view_players') }}" class="btn btn-secondary">Back to Player List</a>
      {% endif %}
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
